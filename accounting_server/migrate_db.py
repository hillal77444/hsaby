import os
import subprocess
import sys
import time

def run_command(command):
    """ØªÙ†ÙÙŠØ° Ø£Ù…Ø± ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…"""
    try:
        result = subprocess.run(command, shell=True, check=True, capture_output=True, text=True)
        print(f"âœ… ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø± Ø¨Ù†Ø¬Ø§Ø­: {command}")
        return True
    except subprocess.CalledProcessError as e:
        print(f"âŒ ÙØ´Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø±: {command}")
        print(f"Ø§Ù„Ø®Ø·Ø£: {e.stderr}")
        return False

def setup_database():
    """Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    commands = [
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
        "mkdir -p /root/accounting_server/data",
        "chown -R postgres:postgres /root/accounting_server/data",
        
        # ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª PostgreSQL
        "sed -i 's|data_directory = .*|data_directory = \'/root/accounting_server/data\'|' /etc/postgresql/*/main/postgresql.conf",
        
        # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ PostgreSQL
        "systemctl restart postgresql",
        
        # Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø®Ø¯Ù…Ø©
        "sleep 5",
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        "sudo -u postgres psql -c \"CREATE DATABASE accounting_db;\"",
        "sudo -u postgres psql -c \"CREATE USER accounting_user WITH PASSWORD 'Accounting@123';\"",
        "sudo -u postgres psql -c \"GRANT ALL PRIVILEGES ON DATABASE accounting_db TO accounting_user;\"",
        
        # ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        "flask db upgrade"
    ]
    
    for command in commands:
        if not run_command(command):
            print("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
            return False
    
    print("âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­")
    return True

if __name__ == "__main__":
    print("ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ù†Ù‚Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...")
    if setup_database():
        print("âœ¨ ØªÙ… Ù†Ù‚Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!")
    else:
        print("âŒ ÙØ´Ù„ Ù†Ù‚Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
        sys.exit(1) 